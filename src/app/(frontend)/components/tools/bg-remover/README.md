# Background Remover Component

## Overview

The Background Remover is an advanced image processing tool integrated into the application. It allows users to upload images, and using a sophisticated AI model, it automatically identifies and removes the background, leaving a transparent foreground. The component handles batch processing, displays real-time progress, and allows users to download individual or multiple processed images.

**New Feature**: The component now includes comprehensive background customization options, allowing users to replace the removed background with solid colors, custom images, or maintain transparency with adjustable opacity levels.

This feature is designed to be robust, leveraging Web Workers for CPU-intensive tasks to ensure the main browser thread remains responsive, providing a smooth user experience even during heavy processing.

## Architecture

The Background Remover's architecture is modular, built around a central UI component (`BackgroundRemover.tsx`) orchestrated by a series of custom React hooks and Web Workers.

### Core Components & Hooks

1. **`BackgroundRemover.tsx`**:
    * The main React component that users interact with.
    * Renders the UI for file uploads, image galleries, progress displays, action buttons, and background customization options.
    * Utilizes `useBackgroundRemovalController` to manage the overall logic.
    * Manages background color and image state for applying to processed images.

2. **`useBackgroundRemovalController.ts`**:
    * The primary orchestrator hook.
    * Manages the entire image processing pipeline: file handling, queue management for different stages, worker coordination, and state updates (image list, errors, loading states).
    * Now includes background color and image parameters for processing images with custom backgrounds.
    * Integrates three stage-specific controller hooks:
        * **`usePreprocessingController.ts`**: Manages the preprocessing workers.
        * **`useSegmentationController.ts`**: Manages the AI segmentation workers and model loading.
        * **`usePostprocessingController.ts`**: Manages the mask application (postprocessing) workers with background customization support.

3. **`useWorkerController.ts`**:
    * A generic utility hook responsible for managing a pool of Web Workers.
    * Handles worker initialization, job assignment, message listening, error handling, and cleanup.
    * It's used by each of the stage-specific controller hooks (`usePreprocessingController`, `useSegmentationController`, `usePostprocessingController`) to manage their respective worker pools.

4. **Web Workers (`./components/engine/`)**:
    * **`preprocessing_worker.js`**: Handles initial image preparation (e.g., converting to a standard format like PNG data URL).
    * **`segmentation_worker.js`**: Performs the core AI-driven background segmentation using the `briaai/RMBG-1.4` model from Hugging Face Transformers.js. This worker is also responsible for loading and managing the AI model.
    * **`postprocessing_worker.js`**: Applies the segmentation mask (generated by `segmentation_worker.js`) to the image to create a transparent background. **Enhanced** to support custom background colors and images with alpha transparency controls.

5. **Background Control Components (`./components/interface/background/`)**:
    * **`BackgroundControl.tsx`**: Main background customization interface that orchestrates all background options.
    * **`BackgroundModeToggle.tsx`**: Toggle between color and image background modes.
    * **`ColorPreview.tsx`**: Visual preview of selected background colors with transparency.
    * **`PresetColors.tsx`**: Grid of preset background colors including transparent option.
    * **`CustomColorPicker.tsx`**: Custom color selection with hex input and alpha transparency slider.
    * **`ColorHistory.tsx`**: Recently used colors with localStorage persistence.
    * **`ImageUpload.tsx`**: Background image upload with preview and alpha transparency controls.
    * **`ColorAlphaSlider.tsx`**: Reusable alpha transparency slider component.

6. **UI Sub-components (`./components/interface/`)**:
    * `UploadSection.tsx`: UI for dragging & dropping or selecting image files.
    * `ImageGallery.tsx` & `ImageCard.tsx`: Displays uploaded images, their processing status, previews, and download/remove actions.
    * `JobProgressList.tsx`: Shows overall and per-stage progress for the batch.
    * `ModelLoadingProgress.tsx`: Visual feedback for AI model download and initialization.
    * `ProcessingNotice.tsx`: A notice displayed during active processing to inform the user.

### Directory Structure

```sh
bg-remover/
├── BackgroundRemover.tsx # Main UI component
├── README.md # This file
├── components/
│ ├── engine/ # Web Workers and related types
│ │ ├── postprocessing_worker.js # Enhanced with background support
│ │ ├── preprocessing_worker.js
│ │ ├── segmentation_worker.js
│ │ └── types.d.ts # Types for worker messages and controller options
│ └── interface/ # UI sub-components
│ ├── ImageCard.tsx
│ ├── ImageGallery.tsx
│ ├── ImageThumbnail.tsx
│ ├── ImageUploadControl.tsx
│ ├── JobProgressList.tsx
│ ├── ModelLoadingProgress.tsx
│ ├── ProcessingNotice.tsx
│ ├── UploadSection.tsx
│ ├── BackgroundControl.tsx # NEW: Main background options interface
│ ├── VersionInfo.tsx # NEW: Version information display
│ ├── background/ # NEW: Background-specific components
│ │ ├── BackgroundModeToggle.tsx
│ │ ├── ColorPreview.tsx
│ │ ├── PresetColors.tsx
│ │ ├── CustomColorPicker.tsx
│ │ ├── ColorHistory.tsx
│ │ ├── ImageUpload.tsx
│ │ ├── ColorAlphaSlider.tsx
│ │ ├── types.ts
│ │ └── index.ts
│ └── index.ts
├── hooks/ # Custom React hooks for logic and state management
│ ├── index.ts
│ ├── types.ts # Specific types for the bg-remover hooks
│ ├── useBackgroundRemovalController.ts # Enhanced with background support
│ ├── usePostprocessingController.ts # Enhanced with background support
│ ├── usePreprocessingController.ts
│ ├── useSegmentationController.ts
│ └── useWorkerController.ts
└── utils/ # Utility functions
└── file.ts
```

## Workflow & Logic

The background removal process is a multi-stage pipeline with enhanced background customization:

1. **File Upload & Initialization**:
    * User uploads one or more images via the `UploadSection`.
    * `useBackgroundRemovalController` creates an `ExtendedImageJob` for each file, with an initial status of `pending_preprocessing`.
    * **New**: Jobs now include background color and image settings from the current `BackgroundControl` state.
    * Blob URLs are generated for previews.
    * If it's the first upload and the model isn't loaded/loading, the `useSegmentationController` initiates model loading (phased, starting with one worker).

2. **Background Customization**:
    * **New Feature**: Users can now customize backgrounds through the `BackgroundControl` component:
        * **Color Mode**: Choose from preset colors (including transparent), custom hex colors, or recently used colors
        * **Image Mode**: Upload custom background images
        * **Transparency Controls**: Adjust alpha transparency for both colors and images (0-100%)
        * **Real-time Preview**: See background changes applied to completed images instantly
        * **Persistent History**: Color choices are saved to localStorage for future sessions

3. **Batch Processing Start**:
    * User clicks "Start Processing Batch".
    * `useBackgroundRemovalController` sets `isBatchActive` to `true`.
    * Jobs with `pending_preprocessing` status are added to the `preprocessingQueueRef`.
    * The `preprocessingQueue` processing is triggered.

4. **Stage 1: Preprocessing (Parallel via Web Workers)**
    * `usePreprocessingController` picks jobs from its queue.
    * For each job:
        * An available `preprocessing_worker.js` is assigned.
        * The image file is fetched (from its `originalBlobUrl`) and converted to a data URL.
        * This data URL is sent to the worker.
        * Job status changes to `preprocessing`.
    * **Inside `preprocessing_worker.js`**:
        * Converts the received data URL to an `ImageBitmap`.
        * Draws it onto an `OffscreenCanvas`.
        * Exports the canvas content as a new PNG data URL (`preprocessedImageUrl`).
        * Sends this `preprocessedImageUrl` back to the main thread.
    * `usePreprocessingController` receives the result:
        * Updates the job with `preprocessedImageUrl`.
        * Changes job status to `queued` (if segmentation model is loaded) or `pending_segmentation`.
        * Adds the job ID to `segmentationQueueRef`.
        * Triggers the `segmentationQueue`.

5. **Stage 2: Segmentation (Parallel via Web Workers)**
    * `useSegmentationController` picks jobs from its queue.
    * **Model Loading**: This controller also manages the AI model.
        * Workers are instructed to load the `briaai/RMBG-1.4` model.
        * Progress (`MODEL_LOADING_PROGRESS`) and status (`MODEL_LOADING_STATUS`) messages are sent to the main thread for UI updates.
        * The global `modelLoaded` state is updated once at least one worker has successfully loaded the model.
    * For each job (if model is loaded and worker is ready):
        * An available `segmentation_worker.js` (with a loaded model) is assigned.
        * The `preprocessedImageUrl` is sent to the worker.
        * Job status changes to `segmentation`.
    * **Inside `segmentation_worker.js`**:
        * Uses the loaded Hugging Face Transformers.js pipeline (`pipeline('image-segmentation', 'briaai/RMBG-1.4')`).
        * Processes the image: `segmenter(imageDataUrl, { return_mask: true })`.
        * The result typically includes a `mask_base64` (a base64 encoded PNG string of the foreground mask).
        * Sends this segmentation result back.
    * `useSegmentationController` receives the result:
        * Updates the job with `segmentationResult`.
        * Changes job status to `pending_postprocessing`.
        * Adds the job ID to `postprocessingQueueRef`.
        * Triggers the `postprocessingQueue` (mask application).

6. **Stage 3: Postprocessing / Mask Application (Parallel via Web Workers)**
    * `usePostprocessingController` picks jobs from its queue.
    * For each job:
        * An available `postprocessing_worker.js` is assigned.
        * **Enhanced**: The `preprocessedImageUrl`, `segmentationResult`, and **background settings** (color, image URL, alpha values) are sent.
        * Job status changes to `postprocessing`.
    * **Inside `postprocessing_worker.js` (Enhanced)**:
        * Decodes the `mask_base64` from `segmentationResult` into an image/canvas.
        * Loads the `preprocessedImageUrl`.
        * **New**: Loads background image if specified.
        * Creates a new `OffscreenCanvas`, optionally draws background color or image.
        * Draws the `preprocessedImageUrl` on top.
        * Iterates through the mask pixels. If a mask pixel indicates background, the corresponding pixel's alpha channel in the `preprocessedImage` canvas is set to `0` (transparent) or replaced with background content.
        * **New**: Applies alpha transparency to background elements as specified.
        * Exports the modified canvas as a new PNG data URL (`transparentImageDataUrl`).
        * Sends this `transparentImageDataUrl` back.
    * `usePostprocessingController` receives the result:
        * Updates the job with `processedImageUrl` and `processedFileSize`.
        * Changes job status to `completed`.
        * Triggers its own queue for the next job.

7. **Background Reprocessing**:
    * **New Feature**: When users change background settings and click "Apply", completed images are automatically reprocessed with the new background without requiring full re-segmentation.
    * This provides instant feedback for background customization experiments.

8. **Batch Completion & UI Updates**:
    * Throughout the process, `imageList` is updated, causing the UI (`JobProgressList`, `ImageGallery`, `BackgroundControl`) to re-render and show current statuses and previews.
    * `useBackgroundRemovalController` monitors queues and worker statuses. When all jobs are `completed` or `error`, all queues are empty, and all workers are idle, it sets `isBatchActive` to `false`.
    * It includes logic to re-queue jobs that might get "stuck" in an intermediate state if workers become unresponsive or errors occur.

### State Management & Data Flow

* The primary state is `imageList` (an array of `ExtendedImageJob` objects) managed in `useBackgroundRemovalController`.
* Each `ExtendedImageJob` object tracks its progress through various statuses (`pending_preprocessing`, `preprocessing`, `pending_segmentation`, `queued`, `segmentation`, `pending_postprocessing`, `postprocessing`, `completed`, `error`) and holds intermediate data like `preprocessedImageUrl`, `segmentationResult`, and the final `processedImageUrl`.
* **New**: Jobs now include background settings (`backgroundColor`, `backgroundColorAlpha`, `backgroundImageUrl`, `backgroundImageAlpha`) that are applied during postprocessing.
* Refs (`preprocessingQueueRef`, `segmentationQueueRef`, `postprocessingQueueRef`) are used to manage queues of job IDs for each processing stage.
* State variables like `modelLoading`, `modelLoaded`, `isBatchActive`, and `overallError` control UI elements and overall flow.
* **New**: Background state (`backgroundColor`, `backgroundImageUrl`, alpha values) is managed in the main component and passed to the controller.

### Error Handling

* Each worker stage has error handling. If a worker crashes or reports an error, the corresponding job status is set to `error`, and an error message is stored.
* `useWorkerController` includes retry mechanisms for worker script initialization.
* `useSegmentationController` manages model loading errors, potentially falling back or reporting failure.
* An `overallError` state captures critical system-wide errors.
* **New**: Background image loading errors are handled gracefully, falling back to color or transparency.

## Background Customization Features

### Color Backgrounds

* **Preset Colors**: 10 predefined colors including transparent, white, black, and various soft tones
* **Custom Colors**: Hex color picker with real-time preview
* **Color History**: Automatically saves and displays recently used colors (stored in localStorage)
* **Transparency Control**: Alpha slider for adjusting color opacity (0-100% transparency)

### Image Backgrounds

* **Image Upload**: Support for common image formats (JPEG, PNG, GIF, WebP)
* **Auto-scaling**: Background images are automatically scaled to match the processed image dimensions
* **Transparency Control**: Alpha slider for adjusting background image opacity
* **Real-time Preview**: See how the background image will look with current transparency settings
* **Memory Management**: Automatic cleanup of blob URLs to prevent memory leaks

### User Experience

* **Mode Toggle**: Easy switching between color and image background modes
* **Apply System**: Changes are previewed immediately, with explicit "Apply" buttons for reprocessing completed images
* **Responsive Design**: Background controls adapt to different screen sizes
* **Accessibility**: Proper ARIA labels and keyboard navigation support

## Technologies Used

* **React 18+**: For building the user interface.
* **Next.js**: Framework for server-side rendering and static site generation (though this component is client-heavy).
* **TypeScript**: For static typing and improved code quality.
* **Web Workers**: To offload computationally intensive image processing tasks from the main browser thread, preventing UI freezes.
* **Hugging Face Transformers.js (`@huggingface/transformers`)**: Used in the `segmentation_worker.js` to run the `briaai/RMBG-1.4` image segmentation model directly in the browser.
* **JSZip**: For creating ZIP archives when downloading multiple images.
* **Framer Motion**: For animations in UI components.
* **Tailwind CSS & CSS Modules**: For styling.
* **Canvas API & OffscreenCanvas**: For image manipulation and background application.

## Usage

To use the Background Remover component in your application:

1. Ensure all dependencies (especially `@huggingface/transformers` and `jszip`) are installed.
2. Import the component:

    ```tsx
    import { BackgroundRemover } from '@/frontend/components/tools/bg-remover';
    ```

3. Render it in your desired page/component:

    ```tsx
    // Example Page
    const MyImageToolsPage = () => {
      return (
        <div>
          <h1>Image Tools</h1>
          <BackgroundRemover />
        </div>
      );
    };

    export default MyImageToolsPage;
    ```

The component is self-contained regarding its core logic and will handle the entire background removal and customization process once rendered.

### Background Customization Workflow

1. **Upload Images**: Use the upload section to select one or more images
2. **Process Images**: Click "Start Processing Batch" to remove backgrounds
3. **Customize Backgrounds**: Once processing is complete, use the "Background Options" accordion to:
   * Choose preset colors or upload custom images
   * Adjust transparency levels
   * Preview changes in real-time
   * Apply changes to reprocess completed images
4. **Download Results**: Download individual images or create a ZIP archive of all processed images

## Further Considerations

* **Performance**: While Web Workers significantly improve performance, processing very large images or huge batches can still be resource-intensive. Background image processing adds minimal overhead.
* **Model Size**: The `briaai/RMBG-1.4` model needs to be downloaded by the client's browser on first use (then cached). This can take time on slower connections. The `ModelLoadingProgress` component provides feedback.
* **Browser Compatibility**: Web Workers and `OffscreenCanvas` are widely supported in modern browsers, but older browsers might have issues. Transformers.js also has its own browser requirements.
* **Memory Management**: The component includes comprehensive memory management for background images and previews, automatically cleaning up blob URLs to prevent memory leaks.
* **Storage**: Color history is persisted in localStorage and automatically managed (limited to recent colors to prevent storage bloat).
